name: Inbox Auto Organize

on:
  workflow_dispatch:
    inputs:
      targets:
        description: "Newline-separated inbox targets to process (inbox/<name>.md or inbox/<dir>/index.md). Leave empty to process all top-level inbox entries."
        required: false
        type: string

concurrency:
  group: inbox-auto-organize-${{ github.ref }}
  cancel-in-progress: false

jobs:
  organize:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    env:
      # Secrets are not allowed in `if:` expressions, so map them to env first.
      CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      # Optional: use a PAT for pushing to main if repository rules block GITHUB_TOKEN.
      # Create a fine-grained PAT with Contents: Read and write, scoped to this repo.
      REPO_PUSH_PAT: ${{ secrets.REPO_PUSH_PAT }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Compute Inbox Targets
        id: targets
        shell: bash
        env:
          TARGETS_INPUT: ${{ github.event.inputs.targets }}
        run: |
          set -euo pipefail

          if [ -n "${TARGETS_INPUT:-}" ]; then
            FILES="${TARGETS_INPUT}"
          else
            # workflow_dispatch (no explicit targets): process all top-level inbox entries.
            FILES="$(
              (ls -1 inbox/*.md 2>/dev/null || true)
              (find inbox -maxdepth 2 -type f -path 'inbox/*/index.md' 2>/dev/null || true)
            )"
          fi

          TARGETS="$(
            printf '%s\n' "${FILES}" \
              | sed '/^$/d' \
              | awk '
                  $0 ~ /^inbox\/[^\/]+\.md$/ { print; next }
                  $0 ~ /^inbox\/[^\/]+\/index\.md$/ { print; next }
                ' \
              | sort -u
          )"

          COUNT="$(printf '%s\n' "${TARGETS}" | sed '/^$/d' | wc -l | tr -d ' ')"

          {
            echo "count=${COUNT}"
            echo "targets<<EOF"
            printf '%s\n' "${TARGETS}"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Skip If No Targets
        if: ${{ steps.targets.outputs.count == '0' }}
        shell: bash
        run: echo "No inbox targets in this event."

      - name: Fail If No Claude Credentials
        if: ${{ steps.targets.outputs.count != '0' && env.CLAUDE_CODE_OAUTH_TOKEN == '' && env.ANTHROPIC_API_KEY == '' }}
        shell: bash
        run: |
          echo "Missing credentials."
          echo "Set either secrets.CLAUDE_CODE_OAUTH_TOKEN (Claude Code subscription OAuth) or secrets.ANTHROPIC_API_KEY (direct API)."
          exit 1

      - name: Organize Inbox + Translate (Claude Code via OAuth)
        if: ${{ steps.targets.outputs.count != '0' && env.CLAUDE_CODE_OAUTH_TOKEN != '' }}
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ env.CLAUDE_CODE_OAUTH_TOKEN }}
          allowed_bots: github-actions
          claude_args: |
            --max-turns 200
            --allowedTools "Edit,Read,Write,Bash"
          prompt: |
            You are an automation agent for this repository.
            Do NOT run git commands (git add/commit/push). A later workflow step will commit/push.

            Goal:
            - When new articles are saved under inbox/, automatically classify and move them into inbox/<category>/...
            - If the content is NOT primarily Japanese, create a full Japanese translation as index.ja.md.

            Target inputs (process ONLY these paths, and ignore any other inbox entries):
            ${{ steps.targets.outputs.targets }}
            Notes:
            - The only valid target shapes are: inbox/<name>.md and inbox/<dir>/index.md
            - Do not touch anything already under inbox/<category>/...

            Categories (directory names):
            - programming
            - design
            - marketing
            - business
            - buddhism
            - reading
            - other

            Rules:
            1) For each target entry, choose exactly one category based on the content.
            2) Move/normalize structure:
               - If the entry is a file inbox/<name>.md:
                 - Create directory inbox/<category>/<name>/
                 - Move the file to inbox/<category>/<name>/index.md
               - If the entry is a directory inbox/<dir>/ with inbox/<dir>/index.md:
                 - Move the whole directory to inbox/<category>/<dir>/
                 - Example: inbox/foo/index.md -> inbox/programming/foo/index.md (directory name must be preserved)
               - Do NOT create or modify any category index file like inbox/<category>/index.md.
            3) Translation:
               - For each processed entry directory containing index.md:
                 - If index.ja.md already exists, do nothing.
                 - If index.md is primarily Japanese, do nothing.
                 - Otherwise, create index.ja.md as a full Japanese translation of index.md.
               - index.ja.md must:
                 - Start with the EXACT same YAML frontmatter as index.md (copy as-is).
                 - Preserve links/URLs/code blocks as much as possible.
                 - Keep the same heading structure.
            4) Be conservative:
               - Do not summarize. Do not rewrite for style. Translate only.
               - Only move files/directories and create missing index.ja.md files.
               - If there are no targets, do nothing.

            After completion:
            - Each target path must no longer exist at its original location, and the normalized destination must exist under inbox/<category>/... as specified above.

      - name: Organize Inbox + Translate (Claude Code via API Key)
        if: ${{ steps.targets.outputs.count != '0' && env.CLAUDE_CODE_OAUTH_TOKEN == '' && env.ANTHROPIC_API_KEY != '' }}
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ env.ANTHROPIC_API_KEY }}
          allowed_bots: github-actions
          claude_args: |
            --max-turns 200
            --allowedTools "Edit,Read,Write,Bash"
          prompt: |
            You are an automation agent for this repository.
            Do NOT run git commands (git add/commit/push). A later workflow step will commit/push.

            Goal:
            - When new articles are saved under inbox/, automatically classify and move them into inbox/<category>/...
            - If the content is NOT primarily Japanese, create a full Japanese translation as index.ja.md.

            Target inputs (process ONLY these paths, and ignore any other inbox entries):
            ${{ steps.targets.outputs.targets }}
            Notes:
            - The only valid target shapes are: inbox/<name>.md and inbox/<dir>/index.md
            - Do not touch anything already under inbox/<category>/...

            Categories (directory names):
            - programming
            - design
            - marketing
            - business
            - buddhism
            - reading
            - other

            Rules:
            1) For each target entry, choose exactly one category based on the content.
            2) Move/normalize structure:
               - If the entry is a file inbox/<name>.md:
                 - Create directory inbox/<category>/<name>/
                 - Move the file to inbox/<category>/<name>/index.md
               - If the entry is a directory inbox/<dir>/ with inbox/<dir>/index.md:
                 - Move the whole directory to inbox/<category>/<dir>/
                 - Example: inbox/foo/index.md -> inbox/programming/foo/index.md (directory name must be preserved)
               - Do NOT create or modify any category index file like inbox/<category>/index.md.
            3) Translation:
               - For each processed entry directory containing index.md:
                 - If index.ja.md already exists, do nothing.
                 - If index.md is primarily Japanese, do nothing.
                 - Otherwise, create index.ja.md as a full Japanese translation of index.md.
               - index.ja.md must:
                 - Start with the EXACT same YAML frontmatter as index.md (copy as-is).
                 - Preserve links/URLs/code blocks as much as possible.
                 - Keep the same heading structure.
            4) Be conservative:
               - Do not summarize. Do not rewrite for style. Translate only.
               - Only move files/directories and create missing index.ja.md files.
               - If there are no targets, do nothing.

            After completion:
            - Each target path must no longer exist at its original location, and the normalized destination must exist under inbox/<category>/... as specified above.

      - name: Validate Organized Structure
        if: ${{ steps.targets.outputs.count != '0' }}
        shell: bash
        env:
          TARGETS: ${{ steps.targets.outputs.targets }}
        run: |
          set -euo pipefail

          CATS=(programming design marketing business buddhism reading other)

          for c in "${CATS[@]}"; do
            if [ -f "inbox/${c}/index.md" ] || [ -f "inbox/${c}/index.ja.md" ]; then
              echo "Invalid output: category index file must not exist: inbox/${c}/index.md or inbox/${c}/index.ja.md"
              exit 1
            fi
          done

          while IFS= read -r t; do
            # GitHub sometimes injects CRLF into multiline inputs/outputs.
            t="${t//$'\r'/}"
            [ -z "$t" ] && continue

            if [[ "$t" =~ ^inbox/[^/]+\\.md$ ]]; then
              base="$(basename "$t" .md)"

              if [ -e "$t" ]; then
                echo "Invalid output: target file still exists: $t"
                exit 1
              fi

              found=""
              for c in "${CATS[@]}"; do
                candidate="inbox/${c}/${base}/index.md"
                if [ -f "$candidate" ]; then
                  if [ -n "$found" ]; then
                    echo "Invalid output: multiple destinations for $t:"
                    echo "- $found"
                    echo "- $candidate"
                    exit 1
                  fi
                  found="$candidate"
                fi
              done

              if [ -z "$found" ]; then
                echo "Invalid output: destination not found for $t (expected inbox/<category>/${base}/index.md)"
                exit 1
              fi

            elif [[ "$t" =~ ^inbox/[^/]+/index\\.md$ ]]; then
              d="$(dirname "$t")"
              d="${d#inbox/}"

              if [ -d "inbox/${d}" ]; then
                echo "Invalid output: original directory still exists: inbox/${d}"
                exit 1
              fi

              found=""
              for c in "${CATS[@]}"; do
                candidate="inbox/${c}/${d}/index.md"
                if [ -f "$candidate" ]; then
                  if [ -n "$found" ]; then
                    echo "Invalid output: multiple destinations for $t:"
                    echo "- $found"
                    echo "- $candidate"
                    exit 1
                  fi
                  found="$candidate"
                fi
              done

              if [ -z "$found" ]; then
                echo "Invalid output: destination not found for $t (expected inbox/<category>/${d}/index.md)"
                exit 1
              fi

            else
              echo "Invalid target shape: $t"
              exit 1
            fi
          done <<< "${TARGETS}"

      - name: Commit Changes
        if: ${{ steps.targets.outputs.count != '0' }}
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail

          if git diff --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # claude-code-action may rewrite the origin URL to use its temporary app token,
          # and then revoke it at the end of the step. Reset origin to the workflow token.
          PUSH_TOKEN="${REPO_PUSH_PAT:-${GH_TOKEN}}"
          git remote set-url origin "https://x-access-token:${PUSH_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"

          # actions/checkout typically leaves us in detached HEAD; ensure a local main branch.
          git checkout -B main

          git add -A
          git commit -m "chore: organize inbox"

          # Prefer pushing directly to main. If repository rules require PRs for main,
          # fall back to pushing a branch (no PR creation).
          if git push origin main; then
            exit 0
          fi

          BRANCH="inbox/auto-organize-${GITHUB_RUN_ID}"
          echo "Push to main failed (likely repository rules). Pushing branch: ${BRANCH}"

          git checkout -B "$BRANCH"
          git push origin "$BRANCH"

          echo "Branch pushed. Merge it manually if needed:"
          echo "https://github.com/${GITHUB_REPOSITORY}/compare/main...${BRANCH}"
