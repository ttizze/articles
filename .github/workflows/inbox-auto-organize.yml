name: Inbox Auto Organize

on:
  workflow_dispatch:
    inputs:
      targets:
        description: "Newline-separated inbox targets to process (_inbox/<name>.md or _inbox/<dir>/index.md). Leave empty to process all top-level inbox entries."
        required: false
        type: string

concurrency:
  group: inbox-auto-organize-${{ github.ref }}
  cancel-in-progress: false

jobs:
  organize:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    env:
      # Secrets are not allowed in `if:` expressions, so map them to env first.
      CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      # Optional: use a PAT for pushing to main if repository rules block GITHUB_TOKEN.
      # Create a fine-grained PAT with Contents: Read and write, scoped to this repo.
      REPO_PUSH_PAT: ${{ secrets.REPO_PUSH_PAT }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Compute Inbox Targets
        id: targets
        shell: bash
        env:
          TARGETS_INPUT: ${{ github.event.inputs.targets }}
        run: |
          set -euo pipefail

          if [ -n "${TARGETS_INPUT:-}" ]; then
            FILES="${TARGETS_INPUT}"
          else
            # workflow_dispatch (no explicit targets): process all top-level inbox entries.
            FILES="$(
              (ls -1 _inbox/*.md 2>/dev/null || true)
              (find _inbox -maxdepth 2 -type f -path '_inbox/*/index.md' 2>/dev/null || true)
            )"
          fi

          TARGETS="$(
            printf '%s\n' "${FILES}" \
              | sed '/^$/d' \
              | awk '
                  $0 ~ /^_inbox\/[^\/]+\.md$/ { print; next }
                  $0 ~ /^_inbox\/[^\/]+\/index\.md$/ { print; next }
                ' \
              | sort -u
          )"

          COUNT="$(printf '%s\n' "${TARGETS}" | sed '/^$/d' | wc -l | tr -d ' ')"

          {
            echo "count=${COUNT}"
            echo "targets<<EOF"
            printf '%s\n' "${TARGETS}"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Skip If No Targets
        if: ${{ steps.targets.outputs.count == '0' }}
        shell: bash
        run: echo "No inbox targets in this event."

      - name: Fail If No Claude Credentials
        if: ${{ steps.targets.outputs.count != '0' && env.CLAUDE_CODE_OAUTH_TOKEN == '' && env.ANTHROPIC_API_KEY == '' }}
        shell: bash
        run: |
          echo "Missing credentials."
          echo "Set either secrets.CLAUDE_CODE_OAUTH_TOKEN (Claude Code subscription OAuth) or secrets.ANTHROPIC_API_KEY (direct API)."
          exit 1

      - name: Organize Inbox + Translate (Claude Code via OAuth)
        if: ${{ steps.targets.outputs.count != '0' && env.CLAUDE_CODE_OAUTH_TOKEN != '' }}
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ env.CLAUDE_CODE_OAUTH_TOKEN }}
          allowed_bots: github-actions
          claude_args: |
            --max-turns 200
            --allowedTools "Edit,Read,Write,Bash"
          prompt: |
            You are an automation agent for this repository.
            Do NOT run git commands (git add/commit/push). A later workflow step will commit/push.

            Goal:
            - When new articles are saved under _inbox/, automatically classify and move them into _inbox/<category>/...
            - If the content is NOT primarily Japanese, create a full Japanese translation as index.ja.md.

            Target inputs (process ONLY these paths, and ignore any other inbox entries):
            ${{ steps.targets.outputs.targets }}
            Notes:
            - The only valid target shapes are: _inbox/<name>.md and _inbox/<dir>/index.md
            - Do not touch anything already under _inbox/<category>/...

            Categories (directory names):
            - programming
            - design
            - marketing
            - business
            - buddhism
            - reading
            - other

            Rules:
            1) For each target entry, choose exactly one category based on the content.
            2) Move/normalize structure:
               - If the entry is a file _inbox/<name>.md:
                 - Create directory _inbox/<category>/<name>/
                 - Move the file to _inbox/<category>/<name>/index.md
               - If the entry is a directory _inbox/<dir>/ with _inbox/<dir>/index.md:
                 - Move the whole directory to _inbox/<category>/<dir>/
                 - Example: _inbox/foo/index.md -> _inbox/programming/foo/index.md (directory name must be preserved)
               - Do NOT create or modify any category index file like _inbox/<category>/index.md.
              3) Translation:
                 - For each processed entry directory containing index.md:
                   - If index.ja.md already exists, do nothing.
                   - If index.md is primarily Japanese, do nothing.
                   - Otherwise, create index.ja.md as a bilingual (original + Japanese) translation file.
                 - index.ja.md must:
                    - Start with the EXACT same YAML frontmatter as index.md (copy as-is).
                    - Keep ALL original Markdown blocks from index.md (content must remain identical), render each original block as a blockquote by prefixing each line with `> `, and add the Japanese translation immediately under it as normal (non-blockquote) text (対訳形式).
                    - Use a blockquote for each ORIGINAL block so it is visually distinct.
                    - Example:
                      - Original:
                        - ## Heading
                        - A paragraph.
                        - - Item A
                        - - Item B
                      - index.ja.md:
                        - > ## Heading
                        - 見出し（訳）
                        - > A paragraph.
                        - 段落の日本語訳。
                        - > - Item A
                        - > - Item B
                        - - 項目A
                        - - 項目B
                    - Do NOT translate code blocks or raw URLs; include them only as original (blockquoted) and omit Japanese translation blocks for them.
                    - Preserve links/URLs/code blocks as much as possible.
            4) Be conservative:
               - Do not summarize. Do not rewrite for style. Translate only.
               - Only move files/directories and create missing index.ja.md files.
               - If there are no targets, do nothing.

            After completion:
            - Each target path must no longer exist at its original location, and the normalized destination must exist under _inbox/<category>/... as specified above.

      - name: Organize Inbox + Translate (Claude Code via API Key)
        if: ${{ steps.targets.outputs.count != '0' && env.CLAUDE_CODE_OAUTH_TOKEN == '' && env.ANTHROPIC_API_KEY != '' }}
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ env.ANTHROPIC_API_KEY }}
          allowed_bots: github-actions
          claude_args: |
            --max-turns 200
            --allowedTools "Edit,Read,Write,Bash"
          prompt: |
            You are an automation agent for this repository.
            Do NOT run git commands (git add/commit/push). A later workflow step will commit/push.

            Goal:
            - When new articles are saved under _inbox/, automatically classify and move them into _inbox/<category>/...
            - If the content is NOT primarily Japanese, create a full Japanese translation as index.ja.md.

            Target inputs (process ONLY these paths, and ignore any other inbox entries):
            ${{ steps.targets.outputs.targets }}
            Notes:
            - The only valid target shapes are: _inbox/<name>.md and _inbox/<dir>/index.md
            - Do not touch anything already under _inbox/<category>/...

            Categories (directory names):
            - programming
            - design
            - marketing
            - business
            - buddhism
            - reading
            - other

            Rules:
            1) For each target entry, choose exactly one category based on the content.
            2) Move/normalize structure:
               - If the entry is a file _inbox/<name>.md:
                 - Create directory _inbox/<category>/<name>/
                 - Move the file to _inbox/<category>/<name>/index.md
               - If the entry is a directory _inbox/<dir>/ with _inbox/<dir>/index.md:
                 - Move the whole directory to _inbox/<category>/<dir>/
                 - Example: _inbox/foo/index.md -> _inbox/programming/foo/index.md (directory name must be preserved)
               - Do NOT create or modify any category index file like _inbox/<category>/index.md.
              3) Translation:
                 - For each processed entry directory containing index.md:
                   - If index.ja.md already exists, do nothing.
                   - If index.md is primarily Japanese, do nothing.
                   - Otherwise, create index.ja.md as a bilingual (original + Japanese) translation file.
                 - index.ja.md must:
                    - Start with the EXACT same YAML frontmatter as index.md (copy as-is).
                    - Keep ALL original Markdown blocks from index.md (content must remain identical), render each original block as a blockquote by prefixing each line with `> `, and add the Japanese translation immediately under it as normal (non-blockquote) text (対訳形式).
                    - Use a blockquote for each ORIGINAL block so it is visually distinct.
                    - Example:
                      - Original:
                        - ## Heading
                        - A paragraph.
                        - - Item A
                        - - Item B
                      - index.ja.md:
                        - > ## Heading
                        - 見出し（訳）
                        - > A paragraph.
                        - 段落の日本語訳。
                        - > - Item A
                        - > - Item B
                        - - 項目A
                        - - 項目B
                    - Do NOT translate code blocks or raw URLs; include them only as original (blockquoted) and omit Japanese translation blocks for them.
                    - Preserve links/URLs/code blocks as much as possible.
            4) Be conservative:
               - Do not summarize. Do not rewrite for style. Translate only.
               - Only move files/directories and create missing index.ja.md files.
               - If there are no targets, do nothing.

            After completion:
            - Each target path must no longer exist at its original location, and the normalized destination must exist under _inbox/<category>/... as specified above.

      - name: Validate Organized Structure
        if: ${{ steps.targets.outputs.count != '0' }}
        shell: bash
        env:
          TARGETS: ${{ steps.targets.outputs.targets }}
        run: |
          set -euo pipefail

          CATS=(programming design marketing business buddhism reading other)

          for c in "${CATS[@]}"; do
            if [ -f "_inbox/${c}/index.md" ] || [ -f "_inbox/${c}/index.ja.md" ]; then
              echo "Invalid output: category index file must not exist: _inbox/${c}/index.md or _inbox/${c}/index.ja.md"
              exit 1
            fi
          done

          while IFS= read -r t; do
            # GitHub sometimes injects CRLF into multiline inputs/outputs.
            t="${t//$'\r'/}"
            # Be tolerant of accidental whitespace around lines.
            t="$(printf '%s' "$t" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')"
            [ -z "$t" ] && continue

            if [[ "$t" =~ ^_inbox/[^/]+\.md$ ]]; then
              base="$(basename "$t" .md)"

              if [ -e "$t" ]; then
                echo "Invalid output: target file still exists: $t"
                exit 1
              fi

              found=""
              for c in "${CATS[@]}"; do
                candidate="_inbox/${c}/${base}/index.md"
                if [ -f "$candidate" ]; then
                  if [ -n "$found" ]; then
                    echo "Invalid output: multiple destinations for $t:"
                    echo "- $found"
                    echo "- $candidate"
                    exit 1
                  fi
                  found="$candidate"
                fi
              done

              if [ -z "$found" ]; then
                echo "Invalid output: destination not found for $t (expected _inbox/<category>/${base}/index.md)"
                exit 1
              fi

            elif [[ "$t" =~ ^_inbox/[^/]+/index\.md$ ]]; then
              d="$(dirname "$t")"
              d="${d#_inbox/}"

              if [ -d "_inbox/${d}" ]; then
                echo "Invalid output: original directory still exists: _inbox/${d}"
                exit 1
              fi

              found=""
              for c in "${CATS[@]}"; do
                candidate="_inbox/${c}/${d}/index.md"
                if [ -f "$candidate" ]; then
                  if [ -n "$found" ]; then
                    echo "Invalid output: multiple destinations for $t:"
                    echo "- $found"
                    echo "- $candidate"
                    exit 1
                  fi
                  found="$candidate"
                fi
              done

              if [ -z "$found" ]; then
                echo "Invalid output: destination not found for $t (expected _inbox/<category>/${d}/index.md)"
                exit 1
              fi

            else
              echo "Invalid target shape: $t"
              exit 1
            fi
          done <<< "${TARGETS}"

      - name: Commit Changes
        if: ${{ steps.targets.outputs.count != '0' }}
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail

          if git diff --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # claude-code-action may rewrite the origin URL to use its temporary app token,
          # and then revoke it at the end of the step. Reset origin to the workflow token.
          PUSH_TOKEN="${REPO_PUSH_PAT:-${GH_TOKEN}}"
          git remote set-url origin "https://x-access-token:${PUSH_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"

          # actions/checkout typically leaves us in detached HEAD; ensure a local main branch.
          git checkout -B main

          git add -A
          git commit -m "chore: organize inbox"

          # Prefer pushing directly to main. If repository rules require PRs for main,
          # fall back to pushing a branch (no PR creation).
          if git push origin main; then
            exit 0
          fi

          BRANCH="_inbox/auto-organize-${GITHUB_RUN_ID}"
          echo "Push to main failed (likely repository rules). Pushing branch: ${BRANCH}"

          git checkout -B "$BRANCH"
          git push origin "$BRANCH"

          echo "Branch pushed. Merge it manually if needed:"
          echo "https://github.com/${GITHUB_REPOSITORY}/compare/main...${BRANCH}"
